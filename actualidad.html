<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Actualidad — Progreso de obra</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- Iconos / fuentes -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <!-- Montserrat -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- CSS global del sitio -->
  <link rel="stylesheet" href="/style.css" />
  <link rel="stylesheet" href="/css/header.css" />
  <link rel="stylesheet" href="/css/footer.css" />
  

  <!-- Estilos de esta página -->
  <link rel="stylesheet" href="/css/actualidad.css" />
  <link rel="stylesheet" href="/css/modales.css" />

  <!-- i18next -->
  <script src="https://unpkg.com/i18next@23/i18next.min.js"></script>
  <script src="https://unpkg.com/i18next-http-backend@2/i18nextHttpBackend.min.js"></script>
  <script src="https://unpkg.com/i18next-browser-languagedetector@8/i18nextBrowserLanguageDetector.min.js"></script>
  <script src="/js/i18n.js" defer></script>
</head>

<body class="actualidad-page">
  <!-- Header dinámico -->
  <div id="header-placeholder" role="banner"></div>

  <!-- Flecha volver (debajo del header fijo) -->
  <a href="/index.html" id="backLink" class="vhv-back" aria-label="Volver al inicio">
    <span class="vhv-back__icon" aria-hidden="true">
      <i class="fa-solid fa-arrow-left"></i>
    </span>
    <span class="vhv-back__label" data-i18n="map.back">Volver</span>
  </a>

  <main id="main" class="main-wrap" role="main">
    <section class="actualidad-hero" aria-label="Actualidad">
      <h1 data-i18n="actualidad.title">Actualidad</h1>
      <p class="lead" data-i18n="actualidad.subtitle">Seguimiento de fases y estado de la promoción.</p>
    </section>

    <!-- ====== PROGRESO (línea recta) ====== -->
    <section class="progreso-section" aria-labelledby="obraTitle">
      <div class="io-progress-wrap" style="--rail-y: 120; --icon-size: 52px; --dot-r: 16px;">
        <h3 id="obraTitle" class="obra-progress-title" data-i18n="actualidad.progress">Progreso de obra</h3>

        <section id="estado-obra" class="obra-progress simple" data-current="4" aria-labelledby="obraTitle">
          <svg class="obra__svg" viewBox="0 0 1200 160" preserveAspectRatio="none" aria-hidden="true">
            <line class="obra__rail" x1="140" y1="12" x2="1320" y2="12" />
            <line class="obra__prog" x1="140" y1="12" x2="580" y2="12" />
          </svg>

          <div class="obra__step" data-step="1" style="--x:80;">
            <img class="obra__icon" src="/images/iconos/terreno.png" alt="" aria-hidden="true" />
            <svg class="obra__dot" viewBox="0 0 36 36" aria-hidden="true">
              <circle cx="18" cy="18" r="12" class="dot" />
              <path d="M12 18 l4 4 8-8" class="check" />
            </svg>
            <div class="obra__labels">
              <div class="label" data-i18n="obra.step1.title">Suelo</div>
              <div class="sublabel" data-i18n="obra.step1.sub">Viabilidad</div>
            </div>
          </div>

          <div class="obra__step" data-step="2" style="--x:228.57;">
            <img class="obra__icon" src="/images/iconos/arquitecto.png" alt="" aria-hidden="true" />
            <svg class="obra__dot" viewBox="0 0 36 36" aria-hidden="true">
              <circle cx="18" cy="18" r="12" class="dot" />
              <path d="M12 18 l4 4 8-8" class="check" />
            </svg>
            <div class="obra__labels">
              <div class="label" data-i18n="obra.step2.title">Proyecto</div>
              <div class="sublabel" data-i18n="obra.step2.sub">Diseño</div>
            </div>
          </div>

          <div class="obra__step" data-step="3" style="--x:377.14;">
            <img class="obra__icon" src="/images/iconos/permiso.png" alt="" aria-hidden="true" />
            <svg class="obra__dot" viewBox="0 0 36 36" aria-hidden="true">
              <circle cx="18" cy="18" r="12" class="dot" />
              <path d="M12 18 l4 4 8-8" class="check" />
            </svg>
            <div class="obra__labels">
              <div class="label" data-i18n="obra.step3.title">Permisos</div>
              <div class="sublabel" data-i18n="obra.step3.sub">Licencia</div>
            </div>
          </div>

          <div class="obra__step" data-step="4" style="--x:525.71;">
            <img class="obra__icon" src="/images/iconos/terreno.png" alt="" aria-hidden="true" />
            <svg class="obra__dot" viewBox="0 0 36 36" aria-hidden="true">
              <circle cx="18" cy="18" r="12" class="dot" />
              <path d="M12 18 l4 4 8-8" class="check" />
            </svg>
            <div class="obra__labels">
              <div class="label" data-i18n="obra.step4.title">Terreno</div>
              <div class="sublabel" data-i18n="obra.step4.sub">Preparación</div>
            </div>
          </div>

          <div class="obra__step" data-step="5" style="--x:674.29;">
            <img class="obra__icon" src="/images/iconos/cimentacion.png" alt="" aria-hidden="true" />
            <svg class="obra__dot" viewBox="0 0 36 36" aria-hidden="true">
              <circle cx="18" cy="18" r="12" class="dot" />
              <path d="M12 18 l4 4 8-8" class="check" />
            </svg>
            <div class="obra__labels">
              <div class="label" data-i18n="obra.step5.title">Cimentación</div>
              <div class="sublabel" data-i18n="obra.step5.sub">Base</div>
            </div>
          </div>

          <div class="obra__step" data-step="6" style="--x:822.86;">
            <img class="obra__icon" src="/images/iconos/estructura.png" alt="" aria-hidden="true" />
            <svg class="obra__dot" viewBox="0 0 36 36" aria-hidden="true">
              <circle cx="18" cy="18" r="12" class="dot" />
              <path d="M12 18 l4 4 8-8" class="check" />
            </svg>
            <div class="obra__labels">
              <div class="label" data-i18n="obra.step6.title">Estructura</div>
              <div class="sublabel" data-i18n="obra.step6.sub">Esqueleto</div>
            </div>
          </div>

          <div class="obra__step" data-step="7" style="--x:971.43;">
            <img class="obra__icon" src="/images/iconos/instalacion.png" alt="" aria-hidden="true" />
            <svg class="obra__dot" viewBox="0 0 36 36" aria-hidden="true">
              <circle cx="18" cy="18" r="12" class="dot" />
              <path d="M12 18 l4 4 8-8" class="check" />
            </svg>
            <div class="obra__labels">
              <div class="label" data-i18n="obra.step7.title">Envolvente</div>
              <div class="sublabel" data-i18n="obra.step7.sub">&amp; Instalaciones</div>
            </div>
          </div>

          <div class="obra__step" data-step="8" style="--x:1120;">
            <img class="obra__icon" src="/images/iconos/villa.png" alt="" aria-hidden="true" />
            <svg class="obra__dot" viewBox="0 0 36 36" aria-hidden="true">
              <circle cx="18" cy="18" r="12" class="dot" />
              <path d="M12 18 l4 4 8-8" class="check" />
            </svg>
            <div class="obra__labels">
              <div class="label" data-i18n="obra.step8.title">Acabados</div>
              <div class="sublabel" data-i18n="obra.step8.sub">&amp; Entrega</div>
            </div>
          </div>

          <span class="sr-live visually-hidden"></span>
        </section>
        <!-- CTA bajo la barra -->
        <div class="cta-visita">
          <a href="#modal-contacto"
            class="btn btn-primary"
            data-open="#modal-contacto"
            data-i18n="actualidad.bookVisitBtn"
            aria-haspopup="dialog">
          </a>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer dinámico -->
  <div id="footer-placeholder" role="contentinfo"></div>

  <!-- Host para cargar modales.html -->
  <div id="modals-host" aria-hidden="true"></div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ==== i18n helpers ==== -->
  <script>
    function __applyI18nFallback(scope=document){
      if (!window.i18next) return;
      scope.querySelectorAll('[data-i18n]').forEach(el=>{
        const k = el.getAttribute('data-i18n'); if (!k) return;
        el.textContent = i18next.t(k);
      });
      scope.querySelectorAll('[data-i18n-attr]').forEach(el=>{
        const spec = el.getAttribute('data-i18n-attr'); if (!spec) return;
        const opts = el.getAttribute('data-i18n-opts');
        const [attr,key] = spec.split('|');
        if (attr && key) el.setAttribute(attr, i18next.t(key, opts ? JSON.parse(opts) : undefined));
      });
      document.documentElement.setAttribute('lang', i18next.language || 'es');
    }
    function renderI18n(scope=document){
      if (window.applyI18nAndRoutes) { window.applyI18nAndRoutes(scope); }
      else { __applyI18nFallback(scope); }
    }
  </script>

  <!-- Carga header/footer + sincronización de i18n -->
  <script>
    const headerHost = document.getElementById('header-placeholder');
    const footerHost = document.getElementById('footer-placeholder');

    (function(){
      if (!window.i18next) return;
      const rerender = () => renderI18n(document);
      if (i18next.isInitialized) rerender();
      i18next.on('initialized', rerender);
      i18next.on('loaded', rerender);
      i18next.on('languageChanged', rerender);
    })();

    // Header
    fetch('/partials/header.html')
      .then(r => r.text())
      .then(html => {
        headerHost.innerHTML = html;
        document.querySelectorAll('header a[href]').forEach(a => {
          const href = a.getAttribute('href') || '';
          if (href.endsWith('actualidad.html') || href === '/actualidad.html') {
            a.classList.add('active');
            a.setAttribute('aria-current','page');
          }
        });
        renderI18n(headerHost);
      });

    // Footer
    fetch('/partials/footer.html')
      .then(r => r.text())
      .then(html => {
        footerHost.innerHTML = html;
        renderI18n(footerHost);
      });
  </script>

  <!-- Loader modales.html + apertura de #modal-contacto (robusto, como en index) -->
  <script>
  (function(){
    const HOST = document.getElementById('modals-host');
    let loaded = false;
    let queuedSel = null;

    async function fetchText(url){
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error(`HTTP ${r.status} ${r.statusText}`);
      return await r.text();
    }

    async function ensureModalsLoaded(){
      if (loaded) return true;

      // Intenta mismas rutas que usas en index
      const candidates = ['/partials/modales.html', '/modales.html'];
      let html = '', baseHref = '';

      for (const u of candidates){
        try{
          html = (await fetchText(u)).trim();
          baseHref = new URL(u, document.baseURI).href;
          if (html) break;
        }catch(_e){ /* prueba siguiente */ }
      }
      if (!html){ console.error('No se pudo cargar modales.html'); return false; }

      // Parse en <template>
      const tpl = document.createElement('template');
      tpl.innerHTML = html;
      const frag = tpl.content;

      // Normaliza rutas relativas (por si el parcial usa recursos relativos)
      frag.querySelectorAll('img[src], link[href], a[href], script[src]').forEach(el=>{
        const attr = el.tagName === 'LINK' || el.tagName === 'A' ? 'href' : 'src';
        const val  = el.getAttribute(attr);
        try{ el.setAttribute(attr, new URL(val, baseHref).href); }catch{}
      });

      // Extrae scripts antes de inyectar
      const scripts = Array.from(frag.querySelectorAll('script'));
      scripts.forEach(s => s.remove());

      // Inyecta el HTML del parcial
      HOST.replaceChildren(frag.cloneNode(true));

      // Reaplica i18n solo al bloque de modales
      if (window.applyI18nAndRoutes) window.applyI18nAndRoutes(HOST);
      else if (typeof renderI18n === 'function') renderI18n(HOST);

      // Ejecuta los scripts (incluidos type="module") como en tu index: via Blob -> src blob:
      for (const old of scripts){
        const s = document.createElement('script');
        if (old.type) s.type = old.type;
        if (old.noModule) s.noModule = true;
        if (old.async) s.async = false;  // orden predecible

        if (old.src){
          s.src = old.src;                // ya normalizado arriba
        }else{
          const code = (old.textContent || '');
          const blob = new Blob([code + '\n//# sourceURL=modales.inline.js'], { type: 'text/javascript' });
          // En CSP sin 'unsafe-inline' esto evita el bloqueo
          s.src = URL.createObjectURL(blob);
          // Mantén el tipo original (module o vacío)
          if ((old.type || '').toLowerCase() === 'module') s.type = 'module';
        }
        document.body.appendChild(s);
      }

      loaded = true;

      // Si alguien clicó antes de cargar, abre ahora
      if (queuedSel){ openBySelector(queuedSel); queuedSel = null; }
      return true;
    }

    // Abre usando la delegación [data-open] que define el módulo del parcial
    function openBySelector(sel){
      const fake = document.createElement('button');
      fake.setAttribute('data-open', sel);
      document.body.appendChild(fake);
      fake.click();
      fake.remove();

      // Fallback por si el módulo aún no hubiera enganchado
      const m = document.querySelector(sel);
      if (m && !m.classList.contains('open')){
        m.classList.add('open');
        m.setAttribute('aria-hidden','false');
      }
    }

    // Delegación global: cualquier botón con data-open="#modal-..."
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest?.('[data-open^="#modal-"]');
      if (!btn) return;
      const sel = btn.getAttribute('data-open');

      if (!loaded){
        e.preventDefault();
        queuedSel = sel;
        const ok = await ensureModalsLoaded();
        if (ok) openBySelector(sel);
        return;
      }
      // Si ya está cargado, el script del parcial lo maneja
    });

    // Precarga perezosa
    if ('requestIdleCallback' in window){
      requestIdleCallback(ensureModalsLoaded, { timeout: 2500 });
    }else{
      setTimeout(ensureModalsLoaded, 2500);
    }
  })();
  </script>

  <!-- Tu lógica existente -->
  <script src="/js/progreso-recto.js" defer></script>
</body>
</html>
