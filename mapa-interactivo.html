<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mapa Interactivo — Lombok</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Montserrat (todos los pesos) -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

    <!-- Overrides header / footer -->
    <link rel="stylesheet" href="/css/header.css" />
    <link rel="stylesheet" href="/css/footer.css" />

    <!-- CSS global + mapa (el MISMO que usas en index) -->
    <link rel="stylesheet" href="/style.css" />
    <link rel="stylesheet" href="/css/mapa.css" />

    <!-- Iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>

    <!-- i18next (CDN) -->
    <script src="https://unpkg.com/i18next@23/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-http-backend@2/i18nextHttpBackend.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector@8/i18nextBrowserLanguageDetector.min.js"></script>

    <!-- Suavizado de scroll + margen por header fijo para anclajes -->
    <style>
      html { scroll-behavior: smooth; }
      #section-lombok-map { scroll-margin-top: 90px; }
    </style>
  </head>

  <body>
    <!-- ⬇️ Partial del header (mismo id que en index) -->
    <div id="siteHeader"></div>

    <section class="map-hero" aria-label="Mapa interactivo de Lombok">
      <!-- Flecha fuera del container -->
      <a href="/index.html" class="vhv-back" aria-label="Volver al inicio">
        <span class="vhv-back__icon" aria-hidden="true"><i class="fa-solid fa-arrow-left"></i></span>
        <span class="vhv-back__label" data-i18n="map.back">Volver</span>
      </a>

      <!-- Títulos centrados dentro del container -->
      <div class="map-hero__inner container">
        <h1 class="map-title-h1" data-i18n="map.title">Lombok — Mapa interactivo</h1>
        <p class="map-subtitle" data-i18n="map.subtitle">
          Explora puntos de interés, el circuito de Mandalika y nuestra localización.
        </p>
      </div>
    </section>

    <!-- ========== MAPA LOMBOK (partial host) ========== -->
    <!-- 👇 MISMO host + clase que en index -->
    <div id="lombokMapHost" class="map-scope"></div>

    <!-- ⬇️ Partial del footer (mismo id que en index) -->
    <div id="siteFooter"></div>

    <!--==========  SCRIPTS  ==========-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- i18n init + (si defines renderPage ahí, lo reutilizamos igual que index) -->
    <script src="/js/i18n.js"></script>

    <!-- (Opcional) tu /app.js si en index define helpers globales que afectan al header/footer -->
    <script src="/app.js"></script>

    <!-- Carga dinámica de partials — **idéntica** a la de index -->
    <script>
      function absolutizeUrl(url, baseHref){
        try { return new URL(url, baseHref).href; } catch { return url; }
      }

      function stripLiveServer(html) {
        const tpl = document.createElement('template');
        tpl.innerHTML = html;

        // Comentarios "Code injected by live-server"
        const walker = document.createTreeWalker(tpl.content, NodeFilter.SHOW_COMMENT);
        const toRemove = [];
        let n;
        while ((n = walker.nextNode())) {
          if (/Code injected by live-server/i.test(n.nodeValue || '')) toRemove.push(n);
        }
        toRemove.forEach(c => c.parentNode && c.parentNode.removeChild(c));

        // Scripts de live reload
        tpl.content.querySelectorAll('script').forEach(s => {
          const txt = (s.textContent || '') + ' ' + (s.src || '');
          if (/refreshcss|Live-Reloading|\/ws\b/i.test(txt)) s.remove();
        });

        const div = document.createElement('div');
        div.appendChild(tpl.content.cloneNode(true));
        return div.innerHTML;
      }

      async function loadPartial(hostOrId, url, opts = {}) {
        const host = typeof hostOrId === 'string' ? document.getElementById(hostOrId) : hostOrId;
        if (!host) throw new Error(`Contenedor no encontrado: ${hostOrId}`);

        const finalUrl = url || host.dataset.partial;
        if (!finalUrl) throw new Error(`Falta URL para el parcial en ${host.id || '(sin-id)'}`);

        const res = await fetch(finalUrl, { cache: 'no-store' });
        if (!res.ok) {
          host.innerHTML = errorBox(finalUrl, `HTTP ${res.status} ${res.statusText}`);
          throw new Error(`HTTP ${res.status} ${res.statusText}`);
        }

        let html = (await res.text()).trim();
        if (!html) { host.remove(); return; }

        html = stripLiveServer(html);

        const tpl = document.createElement('template');
        tpl.innerHTML = html;

        // Normaliza recursos relativos al directorio del parcial
        const baseHref = new URL(finalUrl, document.baseURI).href;
        const frag = tpl.content;

        frag.querySelectorAll('img[src], link[href], a[href], script[src]').forEach(el=>{
          const attr = el.tagName === 'LINK' || el.tagName === 'A' ? 'href' : 'src';
          el.setAttribute(attr, absolutizeUrl(el.getAttribute(attr), baseHref));
        });
        frag.querySelectorAll('use[*|href]').forEach(el=>{
          const XLINK = 'http://www.w3.org/1999/xlink';
          const href = el.getAttributeNS(XLINK,'href');
          if(href) el.setAttributeNS(XLINK,'href', absolutizeUrl(href, baseHref));
        });

        const exec = !!opts.executeScripts;
        const scripts = Array.from(frag.querySelectorAll('script'));
        scripts.forEach(s => s.remove());

        host.replaceChildren(frag.cloneNode(true));

        if (exec && scripts.length){
          const base = baseHref;
          for (const old of scripts) {
            const s = document.createElement('script');
            if (old.type) s.type = old.type;
            if (old.noModule) s.noModule = true;
            if (old.async) s.async = true;

            if (old.src) {
              s.src = absolutizeUrl(old.getAttribute('src'), base);
            } else {
              const code = old.textContent || '';
              if ((old.type || '').toLowerCase() === 'module') {
                const blob = new Blob([code + `\n//# sourceURL=${finalUrl}.inline.js`], { type: 'text/javascript' });
                s.type = 'module';
                s.src = URL.createObjectURL(blob);
              } else {
                s.textContent = code;
              }
            }
            host.appendChild(s);
          }
        }
      }

      function errorBox(url, msg){
        return `<div style="padding:1rem; background:#fee; border:1px solid #f99">
          No se pudo cargar <code>${url}</code>: ${msg}
        </div>`;
      }

      (async () => {
        // Header/Footer en paralelo (igual que tu index)
        await Promise.all([
          loadPartial("siteHeader", "/partials/header.html", { executeScripts: false }),
          loadPartial("siteFooter", "/partials/footer.html", { executeScripts: false }),
        ]);

        // Fuerza traducción si tu i18n.js expone renderPage (igual que en index)
        if (window.renderPage) window.renderPage();

        // Mapa (SIN scripts embebidos)
        await loadPartial("lombokMapHost", "/partials/map.html", { executeScripts: false });

        // Importa tu inicializador EXACTO y lánzalo sobre el HOST (no sobre #section-lombok-map)
        const { initLombokMap } = await import('/js/mapa.js');
        const host = document.getElementById('lombokMapHost');
        initLombokMap(host);

        // Marca enlace activo en el header
        document.querySelectorAll('header a[href]').forEach(a => {
          const href = a.getAttribute('href') || '';
          if (href.endsWith('mapa-interactivo.html') || href === '/mapa-interactivo.html') {
            a.classList.add('active'); a.setAttribute('aria-current','page');
          }
        });
      })();
    </script>
  </body>
</html>
