<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inversión — Oportunidad Lombok</title>
  <meta name="description" content="Oportunidad de inversión en ~8 villas boutique en Lombok (Indonesia): KPIs, áreas, costes y comparativa.">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- Iconos / fuentes -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- CSS global -->
  <link rel="stylesheet" href="/style.css" />
  <link rel="stylesheet" href="/css/header.css" />
  <link rel="stylesheet" href="/css/footer.css" />
  <link rel="stylesheet" href="/css/oportunity.css" />
  <link rel="stylesheet" href="/css/graficos.css" />
  <link rel="stylesheet" href="/css/inversion.css" /> <!-- estilos separados -->

  <!-- i18next -->
  <script src="https://unpkg.com/i18next@23/i18next.min.js"></script>
  <script src="https://unpkg.com/i18next-http-backend@2/i18nextHttpBackend.min.js"></script>
  <script src="https://unpkg.com/i18next-browser-languagedetector@8/i18nextBrowserLanguageDetector.min.js"></script>
  <script src="/js/i18n.js"></script>
</head>

<body class="inversion-page" style="background:#fff; color:#092B3F; font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;">
  <!-- Header -->
  <div id="header-placeholder" role="banner"></div>

  <main id="main" class="main-wrap" role="main">
    <!-- ===== Intro sección inversión ===== -->
    <section class="invest-intro"
             aria-label="Introducción a la inversión"
             data-i18n-attr="aria-label|invest.intro.aria">
      <div class="invest-intro__container">
        <p class="invest-intro__eyebrow" data-i18n="invest.intro.eyebrow">Inversión</p>
        <h1 class="invest-intro__title" data-i18n="invest.intro.title">Explora la oportunidad en Lombok</h1>
        <p class="invest-intro__lead" data-i18n="invest.intro.lead">
          Aquí podrás consultar un resumen ejecutivo con KPIs, áreas y costes; y un panel de gráficos con
          comparativas clave (incluidas las llegadas internacionales a BIZAM 2024/2025). Abre los widgets para profundizar.
        </p>
      </div>
    </section>

    <!-- ===== Lanzadores (2 widgets) ===== -->
    <section class="widget-launch"
             aria-label="Secciones de inversión"
             data-i18n-attr="aria-label|invest.widgets.aria">
      <div class="widget-launch__container">
        <div class="widget-launch__grid">
          <!-- Widget Oportunidad -->
          <button type="button"
                  class="widget-card"
                  data-bs-toggle="modal"
                  data-bs-target="#modal-opty"
                  id="btnOpenOpty"
                  data-i18n-attr="aria-label|invest.widgets.opty.aria"
                  aria-label="Abrir sección Oportunidad">
            <span class="widget-card__icon" aria-hidden="true"><i class="fa-solid fa-clipboard-list"></i></span>
            <h3 class="widget-card__title" data-i18n="invest.widgets.opty.title">Oportunidad</h3>
            <p class="widget-card__text" data-i18n="invest.widgets.opty.text">KPIs, áreas, costes y comparativa resumidos en una vista.</p>
            <p class="widget-card__cta" data-i18n="invest.widgets.openCta">Abrir →</p>
          </button>

          <!-- Widget Gráficos -->
          <button type="button"
                  class="widget-card"
                  data-bs-toggle="modal"
                  data-bs-target="#modal-charts"
                  id="btnOpenCharts"
                  data-i18n-attr="aria-label|invest.widgets.charts.aria"
                  aria-label="Abrir sección Gráficos">
            <span class="widget-card__icon" aria-hidden="true"><i class="fa-solid fa-chart-line"></i></span>
            <h3 class="widget-card__title" data-i18n="invest.widgets.charts.title">Gráficos</h3>
            <p class="widget-card__text" data-i18n="invest.widgets.charts.text">Comparativas clave e internacionales BIZAM 2024/25.</p>
            <p class="widget-card__cta" data-i18n="invest.widgets.openCta">Abrir →</p>
          </button>
        </div>
      </div>
    </section>
  </main>

  <!-- ===== Modales fullscreen (debajo del header) ===== -->
  <!-- Oportunidad -->
  <div class="modal fade modal--below-header" id="modal-opty" tabindex="-1" aria-labelledby="modalOptyLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalOptyLabel" data-i18n="invest.modals.opty.title">Oportunidad</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"
                  aria-label="Cerrar" data-i18n-attr="aria-label|invest.modals.close"></button>
        </div>
        <div class="modal-body">
          <div id="opty-modal-host" class="modal-host" aria-live="polite"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráficos -->
  <div class="modal fade modal--below-header" id="modal-charts" tabindex="-1" aria-labelledby="modalChartsLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalChartsLabel" data-i18n="invest.modals.charts.title">Gráficos</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"
                  aria-label="Cerrar" data-i18n-attr="aria-label|invest.modals.close"></button>
        </div>
        <div class="modal-body">
          <div id="charts-modal-host" class="modal-host" aria-live="polite"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div id="footer-placeholder" role="contentinfo"></div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* ========= Utilidades ========= */
    function absolutizeUrl(url, baseHref){
      try { return new URL(url, baseHref).href; } catch { return url; }
    }
    function stripLiveServer(html) {
      const tpl = document.createElement('template');
      tpl.innerHTML = html;
      const walker = document.createTreeWalker(tpl.content, NodeFilter.SHOW_COMMENT);
      const toRemove = [];
      let n;
      while ((n = walker.nextNode())) {
        if (/Code injected by live-server/i.test(n.nodeValue || '')) toRemove.push(n);
      }
      toRemove.forEach(c => c.parentNode && c.parentNode.removeChild(c));
      tpl.content.querySelectorAll('script').forEach(s => {
        const txt = (s.textContent || '') + ' ' + (s.src || '');
        if (/refreshcss|Live-Reloading|\/ws\b/i.test(txt)) s.remove();
      });
      const div = document.createElement('div');
      div.appendChild(tpl.content.cloneNode(true));
      return div.innerHTML;
    }
    async function loadPartial(sel, url, { executeScripts=false } = {}){
      const host = typeof sel === 'string' ? document.querySelector(sel) : sel;
      if (!host) throw new Error(`Contenedor no encontrado: ${sel}`);
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      let html = (await res.text()).trim();
      if (!html) { host.innerHTML=''; return; }
      html = stripLiveServer(html);

      const baseHref = new URL(url, document.baseURI).href;
      const tpl = document.createElement('template');
      tpl.innerHTML = html;
      const frag = tpl.content;

      frag.querySelectorAll('img[src], link[href], a[href], script[src]').forEach(el=>{
        const attr = el.tagName === 'LINK' || el.tagName === 'A' ? 'href' : 'src';
        el.setAttribute(attr, absolutizeUrl(el.getAttribute(attr), baseHref));
      });

      const scripts = Array.from(frag.querySelectorAll('script'));
      scripts.forEach(s => s.remove());

      host.replaceChildren(frag.cloneNode(true));

      if (executeScripts && scripts.length){
        for (const old of scripts) {
          const s = document.createElement('script');
          if (old.type) s.type = old.type;
          if (old.noModule) s.noModule = true;
          if (old.async) s.async = true;

          if (old.src) {
            s.src = absolutizeUrl(old.getAttribute('src'), baseHref);
          } else if ((old.type || '').toLowerCase() === 'module') {
            const blob = new Blob([old.textContent || ''], { type: 'text/javascript' });
            s.type = 'module';
            s.src = URL.createObjectURL(blob);
          } else {
            s.textContent = old.textContent || '';
          }
          host.appendChild(s);
        }
      }
    }

    // Medir header y fijar variable CSS --hdr-h
    function setHeaderOffset(){
      const header = document.querySelector('header.fixed-top') || document.querySelector('header');
      const h = header ? Math.ceil(header.getBoundingClientRect().height) : 72;
      document.documentElement.style.setProperty('--hdr-h', h + 'px');
    }
    // Ajusta el backdrop para que no cubra el header
    function adjustBackdropForHeader(){
      const hdr = getComputedStyle(document.documentElement).getPropertyValue('--hdr-h').trim() || '72px';
      document.querySelectorAll('.modal-backdrop').forEach(b=>{
        b.style.top = hdr;
        b.style.height = `calc(100vh - ${hdr})`;
      });
    }
    // Debounce simple
    function debounce(fn, t=120){
      let to; return (...a)=>{ clearTimeout(to); to=setTimeout(()=>fn.apply(null,a), t); };
    }

    // Cargador perezoso para cada modal (solo 1ª vez)
    async function ensureOptyLoaded(){
      const host = document.getElementById('opty-modal-host');
      if (!host || host.dataset.loaded === 'true') return;
      await loadPartial(host, '/partials/opportunity.html', { executeScripts:false });
      if (window.applyI18nAndRoutes) applyI18nAndRoutes(host);
      else if (window.renderPage) renderPage(host);
      host.dataset.loaded = 'true';
    }
    async function ensureChartsLoaded(){
      const host = document.getElementById('charts-modal-host');
      if (!host || host.dataset.loaded === 'true') return;
      await loadPartial(host, '/partials/graficos.html', { executeScripts:true });
      if (window.applyI18nAndRoutes) applyI18nAndRoutes(host);
      else if (window.renderPage) renderPage(host);
      host.dataset.loaded = 'true';
    }

    (async () => {
      // Header / Footer
      await Promise.all([
        loadPartial('#header-placeholder','/partials/header.html'),
        loadPartial('#footer-placeholder','/partials/footer.html'),
      ]);

      // Fija offset inicial y al redimensionar
      setHeaderOffset();
      window.addEventListener('resize', debounce(setHeaderOffset, 120));

      // Marca activo el enlace de Inversión
      document.querySelectorAll('header a[href]').forEach(a=>{
        const href = (a.getAttribute('href')||'').toLowerCase();
        if (href.endsWith('/inversion.html') || href.includes('/inversion')) {
          a.classList.add('active'); a.setAttribute('aria-current','page');
        }
      });

      // Carga perezosa al abrir el modal + ajuste backdrop
      const modalOpty   = document.getElementById('modal-opty');
      const modalCharts = document.getElementById('modal-charts');

      modalOpty?.addEventListener('show.bs.modal', ensureOptyLoaded);
      modalCharts?.addEventListener('show.bs.modal', ensureChartsLoaded);

      // Cuando ya se muestra (backdrop inyectado) ajusta top/height del backdrop
      modalOpty?.addEventListener('shown.bs.modal', adjustBackdropForHeader);
      modalCharts?.addEventListener('shown.bs.modal', adjustBackdropForHeader);

      // Reajusta backdrop si redimensionas con modal abierto
      window.addEventListener('resize', debounce(()=>{
        setHeaderOffset();
        adjustBackdropForHeader();
      }, 120));

      // Precarga suave en hover/focus
      document.getElementById('btnOpenOpty')?.addEventListener('mouseenter', ensureOptyLoaded, { once:true });
      document.getElementById('btnOpenCharts')?.addEventListener('mouseenter', ensureChartsLoaded, { once:true });

      // Re-render si i18n cambia estando el modal abierto
      if (window.i18next?.on) {
        i18next.on('languageChanged', ()=>{
          const optyHost = document.getElementById('opty-modal-host');
          const chartsHost = document.getElementById('charts-modal-host');
          if (optyHost?.dataset.loaded === 'true') {
            if (window.applyI18nAndRoutes) applyI18nAndRoutes(optyHost);
            else if (window.renderPage) renderPage(optyHost);
          }
          if (chartsHost?.dataset.loaded === 'true') {
            if (window.applyI18nAndRoutes) applyI18nAndRoutes(chartsHost);
            else if (window.renderPage) renderPage(chartsHost);
            if (window.dashboardLombok?.renderAll) {
              chartsHost.querySelectorAll('#dashboard-lombok .chart').forEach(n=> n.innerHTML='');
              chartsHost.querySelectorAll('#dashboard-lombok .legend').forEach(el=> el.innerHTML='');
              window.dashboardLombok.renderAll();
            }
          }
          adjustBackdropForHeader();
        });
      }
    })().catch(console.error);
  </script>

  <!-- Módulos de cálculo/render (si el parcial de oportunidad los usa) -->
  <script type="module" src="/js/opportunity-boot.js"></script>
</body>
</html>
