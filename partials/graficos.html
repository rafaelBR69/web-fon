<!-- /partials/graficos.html -->
<section
  class="charts-scope"
  id="dashboard-lombok"
  aria-label="Panel de gráficos financieros"
  data-i18n-attr="aria-label|charts.scopeAria"
>
  <!-- Cabecera -->
  <div class="charts-head">
    <div>
      <h2 class="title" data-i18n="charts.title">Lombok — Indicadores clave de inversión</h2>
      <p class="lead" data-i18n="charts.lead">
        Comparativa rápida Indonesia vs España (fiscalidad, costes, crecimiento y demanda) y gráfico de <b>llegadas internacionales</b> al Aeropuerto de Lombok (BIZAM). 2024 y <b>2025</b> si hay datos disponibles.
      </p>
    </div>
  </div>

  <!-- ===== GRID 2×2: SOLO TEXTO ===== -->
  <div class="charts-quad">
    <!-- 1) Fiscalidad y beneficios -->
    <section class="card text-card" id="text-fiscalidad">
      <h3 class="punch" data-i18n="charts.cards.fiscalidad.title">Fiscalidad y beneficios</h3>
      <p class="tagline" data-i18n="charts.cards.fiscalidad.tagline">Entorno de inversión y protección del activo.</p>

      <h4>
        <img class="flag-img" src="/images/flags/id.svg" alt="" width="24" height="16" decoding="async" />
        <span data-i18n="charts.common.indonesia">Indonesia</span>
      </h4>
      <ul class="bullets">
        <li data-i18n="charts.cards.fiscalidad.indo.li1">Fiscalidad competitiva para inversión extranjera (PMA).</li>
        <li data-i18n="charts.cards.fiscalidad.indo.li2">Incentivos e instrumentos de protección legal de la propiedad.</li>
        <li data-i18n="charts.cards.fiscalidad.indo.li3">ROI anual estimado en Lombok del <b>15–20&nbsp;%</b> aprox.</li>
      </ul>

      <h4 style="margin-top:.8rem">
        <img class="flag-img" src="/images/flags/es.svg" alt="" width="24" height="16" decoding="async" />
        <span data-i18n="charts.common.spain">España</span>
      </h4>
      <ul class="bullets">
        <li data-i18n="charts.cards.fiscalidad.es.li1">Alta presión fiscal (IRPF, Plusvalía, ITP).</li>
        <li data-i18n="charts.cards.fiscalidad.es.li2">Rentabilidades medias más bajas (<b>4–6&nbsp;%</b>).</li>
        <li data-i18n="charts.cards.fiscalidad.es.li3">Mayor riesgo de ocupación ilegal.</li>
      </ul>
    </section>

    <!-- 2) Costes de entrada -->
    <section class="card text-card" id="text-costes">
      <h3 class="punch" data-i18n="charts.cards.costes.title">Costes de entrada</h3>
      <p class="tagline" data-i18n="charts.cards.costes.tagline">Ticket de acceso, construcción y mantenimiento.</p>

      <h4>
        <img class="flag-img" src="/images/flags/id.svg" alt="" width="24" height="16" decoding="async" />
        <span data-i18n="charts.common.indonesia">Indonesia</span>
      </h4>
      <ul class="bullets">
        <li data-i18n="charts.cards.costes.indo.li1">Precio por m² significativamente más bajo que en España.</li>
        <li data-i18n="charts.cards.costes.indo.li2">Mano de obra y mantenimiento más económicos.</li>
        <li data-i18n="charts.cards.costes.indo.li3">Inversión inicial más accesible.</li>
      </ul>

      <h4 style="margin-top:.8rem">
        <img class="flag-img" src="/images/flags/es.svg" alt="" width="24" height="16" decoding="async" />
        <span data-i18n="charts.common.spain">España</span>
      </h4>
      <ul class="bullets">
        <li data-i18n="charts.cards.costes.es.li1">Alto coste de adquisición y construcción.</li>
        <li data-i18n="charts.cards.costes.es.li2">Burocracia y tasas municipales elevadas.</li>
        <li data-i18n="charts.cards.costes.es.li3">Licencias más exigentes y restrictivas.</li>
      </ul>
    </section>

    <!-- 3) Crecimiento económico -->
    <section class="card text-card" id="text-crecimiento">
      <h3 class="punch" data-i18n="charts.cards.crecimiento.title">Crecimiento económico</h3>
      <p class="tagline" data-i18n="charts.cards.crecimiento.tagline">Momento macro y potencial de revalorización.</p>

      <h4>
        <img class="flag-img" src="/images/flags/id.svg" alt="" width="24" height="16" decoding="async" />
        <span data-i18n="charts.common.indonesia">Indonesia</span>
      </h4>
      <ul class="bullets">
        <li data-i18n="charts.cards.crecimiento.indo.li1">Economía emergente en pleno crecimiento.</li>
        <li data-i18n="charts.cards.crecimiento.indo.li2">Lombok y Mandalika en expansión turística.</li>
        <li data-i18n="charts.cards.crecimiento.indo.li3">Gran potencial de revalorización a medio plazo.</li>
      </ul>

      <h4 style="margin-top:.8rem">
        <img class="flag-img" src="/images/flags/es.svg" alt="" width="24" height="16" decoding="async" />
        <span data-i18n="charts.common.spain">España</span>
      </h4>
      <ul class="bullets">
        <li data-i18n="charts.cards.crecimiento.es.li1">Mercado más maduro, con menor margen de crecimiento.</li>
        <li data-i18n="charts.cards.crecimiento.es.li2">Saturación en destinos turísticos consolidados.</li>
      </ul>
    </section>

    <!-- 4) Demanda turística -->
    <section class="card text-card" id="text-demanda">
      <h3 class="punch" data-i18n="charts.cards.demanda.title">Demanda turística</h3>
      <p class="tagline" data-i18n="charts.cards.demanda.tagline">Ocupación, estacionalidad y mercados emisores.</p>

      <h4>
        <img class="flag-img" src="/images/flags/id.svg" alt="" width="24" height="16" decoding="async" />
        <span data-i18n="charts.common.indonesia">Indonesia</span>
      </h4>
      <ul class="bullets">
        <li data-i18n="charts.cards.demanda.indo.li1">Turismo internacional en crecimiento.</li>
        <li data-i18n="charts.cards.demanda.indo.li2">Alta ocupación anual (≈ <b>70–80&nbsp;%</b> en polos turísticos).</li>
        <li data-i18n="charts.cards.demanda.indo.li3">Mercado diversificado: Australia, Europa y Asia.</li>
      </ul>

      <h4 style="margin-top:.8rem">
        <img class="flag-img" src="/images/flags/es.svg" alt="" width="24" height="16" decoding="async" />
        <span data-i18n="charts.common.spain">España</span>
      </h4>
      <ul class="bullets">
        <li data-i18n="charts.cards.demanda.es.li1">Mercado turístico ya muy desarrollado.</li>
        <li data-i18n="charts.cards.demanda.es.li2">Riesgo de saturación y sobreoferta en zonas maduras.</li>
      </ul>
    </section>
  </div>

  <!-- ===== FILA 100%: GRÁFICO AEROPUERTO ===== -->
  <div class="charts-row">
    <section class="card chart-card wide" id="card-airport">
      <h3 data-i18n="charts.airport.heading">Llegadas internacionales — Aeropuerto Lombok (BIZAM) 2024 vs 2025</h3>
      <div class="meta" data-i18n="charts.airport.meta">Turistas internacionales (Wisman) por mes — BPS NTB. 2025 puede estar incompleto.</div>
      <div class="chart" id="chart-airport" role="img"
           aria-label="Llegadas internacionales a Lombok 2024 vs 2025"
           data-i18n-attr="aria-label|charts.airport.aria"
           style="--h: 320px;"></div>
      <div class="legend" id="legend-airport"></div>
    </section>
  </div>

  <script>
    /* ===== Utils ===== */
    function domReady(fn){
      if (document.readyState !== 'loading') fn();
      else document.addEventListener('DOMContentLoaded', fn, { once:true });
    }
    // Helper i18n
    function T(key, fb=''){ try { return (window.i18next?.t?.(key)) ?? fb; } catch { return fb; } }
    function TArr(key, fb){ try { return (window.i18next?.t?.(key, { returnObjects:true })) ?? fb; } catch { return fb; } }

    /* ===== DATA (BPS NTB) ===== */
    const WISMAN_2024 = [4958, 7748, 5208, 6536, 7742, 6893, 8652, 8122, 7461, 7169, 4947, 6108];
    // 2025: valores de ejemplo; usa null donde no haya dato real
    const WISMAN_2025 = [6295, 4926, 5441, 7812, 8641, 7784, 10512, 10207, null, null, null, null];

    /* ===== Leyenda simple ===== */
    function makeLegend(el, series){
      if(!el) return;
      el.innerHTML = '';
      series.forEach(s=>{
        const item = document.createElement('label');
        item.className = 'item';
        const sw = document.createElement('span'); sw.className = 'sw';
        sw.style.background = s.color;
        const name = document.createElement('span'); name.textContent = s.name;
        item.appendChild(sw); item.appendChild(name);
        el.appendChild(item);
      });
    }

    /* ===== Helpers para paths con nulls (segmentos) ===== */
    function buildSegments(data){
      const segs = [];
      let cur = [];
      data.forEach((v,i)=>{
        if (v == null || Number.isNaN(v)) {
          if (cur.length) { segs.push(cur); cur = []; }
        } else {
          cur.push([i, v]);
        }
      });
      if (cur.length) segs.push(cur);
      return segs;
    }

    /* ===== Core chart (SVG con hover por columna) ===== */
    function getMul(el){
      const scope = el.closest('.charts-scope');
      const cs = getComputedStyle(scope);
      return parseFloat(cs.getPropertyValue('--mul')) || 1.45;
    }

    function createLineChart(container, cfg){
      const mul = getMul(container);
      const pad = { t: 26*mul + 14, r: 40*mul + 32, b: 28*mul + 36, l: 40*mul + 34 };
      const W = Math.max(container.clientWidth || 720, 320);
      const H = container.clientHeight || (360 + (80 * (mul - 1)));

      const svgNS = 'http://www.w3.org/2000/svg';
      const svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
      container.innerHTML = '';
      container.appendChild(svg);

      const xMin = 0, xMax = cfg.labels.length - 1;
      const allVals = cfg.series.flatMap(s => s.data.filter(v => v != null));
      let yMin = Math.min(...allVals), yMax = Math.max(...allVals);
      if (!isFinite(yMin) || !isFinite(yMax)) { yMin = 0; yMax = 1; }
      if (yMin === yMax){ yMin -= 1; yMax += 1; }
      const yPad = (yMax - yMin) * 0.10; yMin -= yPad; yMax += yPad;

      const plotW = W - pad.l - pad.r;
      const plotH = H - pad.t - pad.b;
      const x = i => pad.l + plotW * ((i - xMin) / (xMax - xMin || 1));
      const y = v => pad.t + plotH * (1 - ((v - yMin) / ((yMax - yMin) || 1)));

      // grid
      const gGrid = document.createElementNS(svgNS,'g'); svg.appendChild(gGrid);
      for(let i=0;i<=5;i++){
        const yy = pad.t + plotH * (i/5);
        const gl = document.createElementNS(svgNS,'line');
        gl.setAttribute('x1', pad.l); gl.setAttribute('y1', yy);
        gl.setAttribute('x2', pad.l + plotW); gl.setAttribute('y2', yy);
        gl.setAttribute('class','gridline'); gGrid.appendChild(gl);
      }

      // axis X labels
      const gAxes = document.createElementNS(svgNS,'g'); svg.appendChild(gAxes);
      const xStep = Math.max(1, Math.floor(cfg.labels.length/6));
      cfg.labels.forEach((lab,i)=>{
        if(i % xStep !== 0) return;
        const tx = document.createElementNS(svgNS,'text');
        tx.textContent = lab; tx.setAttribute('x', x(i)); tx.setAttribute('y', H - 12);
        tx.setAttribute('text-anchor','middle'); tx.setAttribute('class','tick');
        gAxes.appendChild(tx);
      });
      if(cfg.yLeftLabel){
        const tl = document.createElementNS(svgNS,'text');
        tl.textContent = cfg.yLeftLabel; tl.setAttribute('x',14); tl.setAttribute('y',pad.t-8);
        tl.setAttribute('class','axis-label'); gAxes.appendChild(tl);
      }

      // series (segmentando por nulls)
      const gSeries = document.createElementNS(svgNS,'g'); svg.appendChild(gSeries);
      cfg.series.forEach(s=>{
        const color = s.color;
        const segs = buildSegments(s.data);
        segs.forEach(seg=>{
          const d = seg.map(([i,v],k)=>`${k?'L':'M'} ${x(i)} ${y(v)}`).join(' ');
          const p = document.createElementNS(svgNS,'path');
          p.setAttribute('d', d); p.setAttribute('class','serie'); p.setAttribute('style', `stroke:${color}`);
          gSeries.appendChild(p);
          seg.forEach(([i,v])=>{
            const c=document.createElementNS(svgNS,'circle');
            c.setAttribute('cx',x(i)); c.setAttribute('cy',y(v)); c.setAttribute('r',3.5*mul);
            c.setAttribute('class','point'); c.setAttribute('style', `fill:#fff;stroke:${color}`);
            gSeries.appendChild(c);
          });
        });
      });

      // tooltip + hover por columna
      const tip=document.createElement('div'); tip.className='tool'; tip.style.display='none'; container.appendChild(tip);
      const guide = document.createElementNS(svgNS,'line');
      guide.setAttribute('class', 'gridline'); guide.setAttribute('y1', pad.t); guide.setAttribute('y2', pad.t + plotH);
      guide.style.opacity = 0; svg.appendChild(guide);

      function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

      svg.addEventListener('mousemove', ev => {
        const rect = svg.getBoundingClientRect();
        const mx   = ev.clientX - rect.left, my = ev.clientY - rect.top;

        if (mx < pad.l || mx > pad.l+plotW || my < pad.t || my > pad.t+plotH) {
          tip.style.display='none'; guide.style.opacity = 0; return;
        }

        const ratio = (mx - pad.l) / (plotW || 1);
        const i = clamp(Math.round(xMin + ratio * (xMax - xMin)), xMin, xMax);

        // locale según i18n (es-ES / en-US)
        const locale = (window.i18next?.resolvedLanguage || 'es').startsWith('en') ? 'en-US' : 'es-ES';
        const fmt = v => (v == null || Number.isNaN(v)) ? '—' : v.toLocaleString(locale);

        const seriesRows = cfg.series.map(s => {
          const v = s.data[i];
          return `<div class="r"><span class="n">${s.name}:</span><span class="v">${fmt(v)}</span></div>`;
        }).join('');

        const ys = cfg.series.map(s => s.data[i]).filter(v => v != null).map(y);
        const yTip = ys.length ? Math.min(...ys) : (pad.t + plotH/2);

        tip.innerHTML = `
          <div class="t">${cfg.labels[i]}</div>
          <div class="s">${seriesRows}</div>
        `;
        tip.style.display = 'block';

        const tipW = tip.offsetWidth || 260;
        tip.style.left = Math.min(x(i) + 16, W - tipW - 8) + 'px';
        tip.style.top  = Math.max(yTip - 46, 0) + 'px';

        guide.setAttribute('x1', x(i));
        guide.setAttribute('x2', x(i));
        guide.style.opacity = 1;
      });

      svg.addEventListener('mouseleave',()=>{ tip.style.display='none'; guide.style.opacity = 0; });

      // leyenda
      makeLegend(cfg.legendEl, cfg.series);
    }

    /* ===== Render ===== */
    function renderAll(){
      const labels = TArr('charts.months', ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"]);
      const yLeftLabel = T('charts.airport.yLabel', 'Personas');
      const s2024 = T('charts.airport.series.y2024', '2024 — Llegadas (BIZAM)');
      const s2025 = T('charts.airport.series.y2025', '2025 — Llegadas (BIZAM)');

      createLineChart(
        document.querySelector('#chart-airport'),
        {
          labels,
          yLeftLabel,
          series: [
            { name: s2024, color:'var(--brand2)', data: WISMAN_2024 },
            { name: s2025, color:'var(--brand4)', data: WISMAN_2025 }
          ],
          legendEl: document.querySelector('#legend-airport')
        }
      );
    }

    function boot(){
      renderAll();

      // Re-render al cambiar idioma
      if (window.i18next?.on) {
        i18next.on('languageChanged', ()=>{
          document.querySelectorAll('#dashboard-lombok .chart').forEach(n=> n.innerHTML='');
          document.querySelectorAll('#dashboard-lombok .legend').forEach(el=> el.innerHTML='');
          renderAll();
          if (window.dispatchEvent) window.dispatchEvent(new Event('i18n-attr-apply'));
        });
      }

      // Re-render al redimensionar
      let rTO;
      window.addEventListener('resize',()=>{
        clearTimeout(rTO);
        rTO=setTimeout(()=>{
          document.querySelectorAll('#dashboard-lombok .chart').forEach(n=> n.innerHTML='');
          document.querySelectorAll('#dashboard-lombok .legend').forEach(el=> el.innerHTML='');
          renderAll();
        },120);
      });
    }
    domReady(boot);

    // Exponer API mínima para repintado externo
    window.dashboardLombok = { renderAll, boot };
  </script>
</section>
