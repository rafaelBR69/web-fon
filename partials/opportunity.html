<section
  id="oportunity"
  class="oportunity-section"
  aria-label="Lombok (Indonesia) — Oportunidad de inversión en villas boutique"
  data-i18n-attr="aria-label|opty.aria"
>
  <div class="opty__container">

    <!-- Intro -->
    <div class="opty__intro">
      <h2 class="opty__title" data-i18n="opty.title">Lombok, Indonesia — Oportunidad de inversión</h2>
      <p class="opty__subtitle" data-i18n="opty.subtitle">
        Promoción boutique cerca de las mejores playas del sur de Lombok. Diseño eficiente para explotación turística y revalorización a medio plazo.
      </p>
    </div>

    <!-- KPIs / Métricas de inversión -->
    <section class="opty__kpis" aria-labelledby="opty-kpi-title">
      <h3 id="opty-kpi-title" class="opty__h3">
        <span data-i18n="opty.kpis.heading">Rentabilidad estimada</span>
        <small class="opty__muted" data-i18n="opty.kpis.headingNote">(precio fijo por unidad)</small>
      </h3>

      <!-- CONTROLES -->
      <div class="opty__controls" role="group"
           data-i18n-attr="aria-label|opty.kpis.controls.groupAria"
           style="display:grid;grid-template-columns:repeat(3, max-content);gap:12px 16px;align-items:end;margin:10px 0 14px;">
        <label class="opty__control" style="display:grid;gap:6px;">
          <span style="font-weight:600;" data-i18n="opty.kpis.controls.units.label">Unidades</span>
          <select data-units
                  style="padding:10px 12px;border:1px solid var(--opty-border);border-radius:12px;"
                  data-i18n-attr="aria-label|opty.kpis.controls.units.aria">
            <option value="1"  data-i18n="opty.kpis.controls.units.options.1">1 villa</option>
            <option value="2"  data-i18n="opty.kpis.controls.units.options.2">2 villas</option>
            <option value="3"  data-i18n="opty.kpis.controls.units.options.3">3 villas</option>
            <option value="4"  data-i18n="opty.kpis.controls.units.options.4">4 villas</option>
            <option value="5"  data-i18n="opty.kpis.controls.units.options.5">5 villas</option>
            <option value="6"  data-i18n="opty.kpis.controls.units.options.6">6 villas</option>
            <option value="7"  data-i18n="opty.kpis.controls.units.options.7">7 villas</option>
            <option value="8" selected data-i18n="opty.kpis.controls.units.options.8">8 villas</option>
            <option value="9"  data-i18n="opty.kpis.controls.units.options.9">9 villas</option>
          </select>
        </label>

        <label class="opty__control" style="display:grid;gap:6px;">
          <span style="font-weight:600;" data-i18n="opty.kpis.controls.scenario.label">Escenario</span>
          <select data-scenario
                  style="padding:10px 12px;border:1px solid var(--opty-border);border-radius:12px;"
                  data-i18n-attr="aria-label|opty.kpis.controls.scenario.aria">
            <option value="conservador" data-i18n="opty.kpis.controls.scenario.options.conservador">Conservador</option>
            <option value="base" selected data-i18n="opty.kpis.controls.scenario.options.base">Base</option>
            <option value="optimista" data-i18n="opty.kpis.controls.scenario.options.optimista">Optimista</option>
          </select>
        </label>

        <!-- Precio por unidad: fijo a 100.000 € (visible pero deshabilitado) -->
        <label class="opty__control" style="display:grid;gap:6px;">
          <span style="font-weight:600;" data-i18n="opty.kpis.controls.unitPrice.label">Precio por unidad (fijo)</span>
          <input data-unit-price value="100000" inputmode="decimal" pattern="[0-9.,]+"
                 disabled
                 style="padding:10px 12px;border:1px solid var(--opty-border);border-radius:12px;background:#f3f6f9;color:#6b7680;"
                 data-i18n-attr="aria-label|opty.kpis.controls.unitPrice.aria">
        </label>
      </div>

      <!-- Nota resumen -->
      <p class="opty__note" data-i18n="opty.kpis.note">
        Configura unidades y escenario. Calculamos automáticamente ingresos (ADR × ocupación) y OPEX (OTA, gestión, variables y fijos) para estimar NOI, payback y TIR.
      </p>

      <div class="opty__kpi-grid">
        <article class="opty__kpi">
          <h4 class="opty__kpi-label" data-i18n="opty.kpis.kpi.capRate.label">Cap rate</h4>
          <p class="opty__kpi-value" data-kpi="cap-rate">—</p>
          <p class="opty__kpi-hint" data-i18n="opty.kpis.kpi.capRate.hint">NOI anual / Inversión total</p>
        </article>
        <article class="opty__kpi">
          <h4 class="opty__kpi-label" data-i18n="opty.kpis.kpi.coc.label">Cash-on-Cash</h4>
          <p class="opty__kpi-value" data-kpi="coc">—</p>
          <p class="opty__kpi-hint" data-i18n="opty.kpis.kpi.coc.hint">Flujo neto / Equity aportado</p>
        </article>
        <article class="opty__kpi">
          <h4 class="opty__kpi-label" data-i18n="opty.kpis.kpi.payback.label">Payback</h4>
          <p class="opty__kpi-value" data-kpi="payback">—</p>
          <p class="opty__kpi-hint" data-i18n="opty.kpis.kpi.payback.hint">Años para recuperar la inversión</p>
        </article>
        <article class="opty__kpi">
          <h4 class="opty__kpi-label" data-i18n="opty.kpis.kpi.irr.label">TIR (IRR)</h4>
          <p class="opty__kpi-value" data-kpi="irr">—</p>
          <p class="opty__kpi-hint" data-i18n="opty.kpis.kpi.irr.hint">Sobre flujos proyectados</p>
        </article>
      </div>

      <ul class="opty__bullets">
        <li data-i18n="opty.kpis.bullets.0">Ingresos: ADR × ocupación × noches vendibles.</li>
        <li data-i18n="opty.kpis.bullets.1">OPEX: comisiones OTA + gestión + variables + fijos.</li>
        <li class="opty__muted" data-i18n="opty.kpis.bullets.2">*Cálculos orientativos antes de impuestos; sujetos a estacionalidad y condiciones reales de operación.*</li>
      </ul>
    </section>

    <!-- Cómo calculamos (expander) -->
    <section class="opty__how" aria-labelledby="how-title" style="margin-top:24px;">
      <details id="calc-expander">
        <summary>
          <span id="how-title" class="opty__h3" style="margin:0;" data-i18n="opty.how.heading">Detalle del cálculo</span>
          <i class="fa-solid fa-chevron-down chev" aria-hidden="true"></i>
        </summary>
        <div class="opty__expander-content">
          <div data-explain></div>
        </div>
      </details>
    </section>

    <!-- Comparativa con Bali -->
    <section class="opty__compare" aria-labelledby="opty-compare-title" style="margin-top:24px;">
      <h3 id="opty-compare-title" class="opty__h3" data-i18n="opty.compare.heading">Comparativa con Bali</h3>
      <div class="opty__table" role="table" data-i18n-attr="aria-label|opty.compare.tableAria">
        <div class="opty__row opty__row--head" role="row">
          <div class="opty__cell" role="columnheader" data-i18n="opty.compare.head.0">Métrica</div>
          <div class="opty__cell" role="columnheader" data-i18n="opty.compare.head.1">Bali (sur, zonas prime)</div>
          <div class="opty__cell" role="columnheader" data-i18n="opty.compare.head.2">Lombok (sur, Kuta/Selong Belanak)</div>
        </div>

        <!-- Row 1 -->
        <div class="opty__row" role="row">
          <div class="opty__cell" role="cell" data-i18n="opty.compare.rows.0.metric">Precio terreno (€/m²)</div>
          <div class="opty__cell" role="cell" data-i18n="opty.compare.rows.0.bali">Más alto</div>
          <div class="opty__cell" role="cell" data-i18n="opty.compare.rows.0.lombok">Más bajo, margen de entrada</div>
        </div>
        <!-- Row 2 -->
        <div class="opty__row" role="row">
          <div class="opty__cell" role="cell" data-i18n="opty.compare.rows.1.metric">Coste villa (€/m² construidos)</div>
          <div class="opty__cell" role="cell" data-i18n="opty.compare.rows.1.bali">Alto</div>
          <div class="opty__cell" role="cell" data-i18n="opty.compare.rows.1.lombok">Medio</div>
        </div>
        <!-- Row 3 -->
        <div class="opty__row" role="row">
          <div class="opty__cell" role="cell" data-i18n="opty.compare.rows.2.metric">ADR / Ocupación</div>
          <div class="opty__cell" role="cell" data-i18n="opty.compare.rows.2.bali">Elevados en prime, competencia intensa</div>
          <div class="opty__cell" role="cell" data-i18n="opty.compare.rows.2.lombok">Creciendo, menor saturación</div>
        </div>
        <!-- Row 4 -->
        <div class="opty__row" role="row">
          <div class="opty__cell" role="cell" data-i18n="opty.compare.rows.3.metric">Regulación alquiler</div>
          <div class="opty__cell" role="cell" data-i18n="opty.compare.rows.3.bali">Madura, con exigencias locales</div>
          <div class="opty__cell" role="cell" data-i18n="opty.compare.rows.3.lombok">En desarrollo, requiere asesoría</div>
        </div>
        <!-- Row 5 -->
        <div class="opty__row" role="row">
          <div class="opty__cell" role="cell" data-i18n="opty.compare.rows.4.metric">Potencial de plusvalía</div>
          <div class="opty__cell" role="cell" data-i18n="opty.compare.rows.4.bali">Más limitado en zonas maduras</div>
          <div class="opty__cell" role="cell" data-i18n="opty.compare.rows.4.lombok">Alto a medio plazo (nuevas infraestructuras)</div>
        </div>
      </div>
      <p class="opty__muted" data-i18n="opty.compare.note">Indicadores cualitativos; sustituye por tus propias métricas cuando dispongas de datos.</p>
    </section>

    <!-- Potencial de plusvalía -->
    <section class="opty__value" aria-labelledby="opty-value-title" style="margin-top:24px;">
      <h3 id="opty-value-title" class="opty__h3" data-i18n="opty.value.heading">Potencial de plusvalía</h3>
      <div class="opty__cards opty__cards--2">
        <article class="opty__card">
          <h4 class="opty__card-title" data-i18n="opty.value.growth.title">Motores de crecimiento</h4>
          <ul class="opty__list">
            <li data-i18n="opty.value.growth.items.0">Nuevas infraestructuras turísticas y mejor conectividad regional.</li>
            <li data-i18n="opty.value.growth.items.1">Menor saturación que Bali en zonas clave del sur.</li>
            <li data-i18n="opty.value.growth.items.2">Oferta limitada de producto prime frente a demanda internacional creciente.</li>
            <li data-i18n="opty.value.growth.items.3">Efecto arrastre de destinos consolidados cercanos.</li>
          </ul>
        </article>
        <article class="opty__card">
          <h4 class="opty__card-title" data-i18n="opty.value.risks.title">Riesgos a monitorizar</h4>
          <ul class="opty__list">
            <li data-i18n="opty.value.risks.items.0">Ejecución de licencias y tiempos administrativos.</li>
            <li data-i18n="opty.value.risks.items.1">Dependencia del turismo internacional.</li>
            <li data-i18n="opty.value.risks.items.2">Riesgo regulatorio local y de uso del suelo.</li>
            <li data-i18n="opty.value.risks.items.3">Tipo de cambio (IDR/EUR) y costes logísticos.</li>
          </ul>
        </article>
      </div>
    </section>

    <!-- Seguridad jurídica -->
    <section class="opty__legal" aria-labelledby="opty-legal-title" style="margin-top:24px;">
      <h3 id="opty-legal-title" class="opty__h3" data-i18n="opty.legal.heading">Seguridad jurídica (visión general)</h3>
      <div class="opty__cards opty__cards--3">
        <article class="opty__card">
          <h4 class="opty__card-title" data-i18n="opty.legal.structures.title">Estructuras habituales</h4>
          <ul class="opty__list">
            <li data-i18n="opty.legal.structures.items.0"><strong>PT PMA + HGB</strong>: sociedad extranjera con derecho de edificación.</li>
            <li data-i18n="opty.legal.structures.items.1"><strong>Hak Pakai</strong>: derecho de uso en casos elegibles.</li>
            <li data-i18n="opty.legal.structures.items.2"><strong>Leasehold</strong>: arrendamiento largo (p.ej., 25–30 años + prórrogas).</li>
          </ul>
        </article>
        <article class="opty__card">
          <h4 class="opty__card-title" data-i18n="opty.legal.checklist.title">Checklist de due diligence</h4>
          <ul class="opty__list">
            <li data-i18n="opty.legal.checklist.items.0">Título y cargas (BPN), límites y acceso.</li>
            <li data-i18n="opty.legal.checklist.items.1">Zonificación/uso del suelo y permisos (p.ej., PBG).</li>
            <li data-i18n="opty.legal.checklist.items.2">Ambiental (UKL-UPL/AMDAL si aplica).</li>
            <li data-i18n="opty.legal.checklist.items.3">Contratos de obra y garantías.</li>
          </ul>
        </article>
        <article class="opty__card">
          <h4 class="opty__card-title" data-i18n="opty.legal.notes.title">Notas</h4>
          <p class="opty__card-text opty__muted" data-i18n="opty.legal.notes.text">
            Requiere asesoría legal/local especializada. Evitar estructuras de <em>nominee</em> sin respaldo legal claro.
          </p>
        </article>
      </div>
    </section>

    <!-- CTA -->
    <footer class="opty__cta">
      <a href="#contacto" class="opty__btn" data-i18n="opty.cta.button">Solicitar dossier financiero</a>
      <p class="opty__disclaimer opty__muted" data-i18n="opty.cta.disclaimer">
        La información es orientativa y no constituye asesoramiento legal ni oferta comercial. Sujeta a verificación documental.
      </p>
    </footer>

  </div>

  <!-- Conexión de controles con el JS de cálculo (igual que antes) -->
  <script type="module">
    import { models, populateOpportunityAdvanced, formatCurrency } from '/js/opportunity-data.js';

    function paintAreas(){
      const A = models?.base?.areas || {};
      const f1i = +A.floor1_indoor_m2 || 0;
      const f1o = +A.floor1_outdoor_m2 || 0;
      const f2i = +A.floor2_indoor_m2 || 0;
      const f2o = +A.floor2_outdoor_m2 || 0;
      const indoor  = f1i + f2i;
      const outdoor = f1o + f2o;
      const gfa     = (indoor + outdoor) || ((+A.floor1_total_m2||0) + (+A.floor2_total_m2||0));
      const setArea = (k,v,u='m²')=>{
        const el = document.querySelector(`#oportunity [data-area="${k}"]`);
        if (el) el.textContent = (v==null? '—' : v.toFixed(2) + ' ' + u);
      };
      const land = +A.land_plot_m2 || 0;
      setArea('land-plot', land);
      setArea('landscape', +A.landscape_m2 || 0);
      setArea('indoor', indoor);
      setArea('outdoor', outdoor);
      setArea('gfa', gfa, 'm² GFA');
      const setMetric = (k,val)=>{
        const el = document.querySelector(`#oportunity [data-metric="${k}"]`);
        if (!el) return;
        if (k==='far') el.textContent = (land>0 ? (gfa/land).toFixed(2) : '—');
        if (k==='coverage') el.textContent = (land>0 ? ((+A.floor1_total_m2||0)/land*100).toFixed(1)+'%' : '—');
        if (k==='efficiency') el.textContent = (gfa>0 ? (indoor/gfa*100).toFixed(1)+'%' : '—');
      };
      setMetric('far'); setMetric('coverage'); setMetric('efficiency');
    }
    function repaint(){
      const selUnits = document.querySelector('#oportunity [data-units]');
      const selScn   = document.querySelector('#oportunity [data-scenario]');
      const units    = parseInt(selUnits?.value || '1', 10) || 1;
      const scenario = (selScn?.value || 'base');
      populateOpportunityAdvanced('#oportunity', models.base, {
        units, unitPriceEUR: 100000, scenario
      });
    }
    document.addEventListener('change', (e)=>{
      if (e.target.closest?.('#oportunity [data-units], #oportunity [data-scenario]')) repaint();
    });
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => { paintAreas(); repaint(); }, { once: true });
    } else { paintAreas(); repaint(); }
  </script>
</section>
