<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Montserrat (todos los pesos) -->
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Overrides header / footer -->
    <link rel="stylesheet" href="/css/header.css" />
    <link rel="stylesheet" href="/css/footer.css" />
    <link rel="stylesheet" href="/css/infinity.css" />

    <!-- CSS y fuentes -->
    <link rel="stylesheet" href="/style.css" />
    <link rel="stylesheet" href="/mediaquaries.css" />

    <!-- ⬇️ Se elimina el antiguo /css/galeria-dia-noche.css y se añade el nuevo -->
    <link rel="stylesheet" href="/css/galeria-infinity.css" />

    <!-- CSS del mapa (encapsulado con .map-scope) -->
    <link rel="stylesheet" href="/css/graficos.css" />
    <link rel="stylesheet" href="/css/mapa.css" />

    <!-- 👉 Ruleta al final para que overridee .section_1 -->
    <link rel="stylesheet" href="/css/ruleta.css" />
    <link rel="stylesheet" href="/css/modales.css" />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&family=Poppins:wght@100;400;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Alegreya+SC:wght@400;500;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Junge&display=swap"
      rel="stylesheet"
    />

    <!-- i18next (CDN) -->
    <script src="https://unpkg.com/i18next@23/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-http-backend@2/i18nextHttpBackend.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector@8/i18nextBrowserLanguageDetector.min.js"></script>

    <!-- Anime.js v3 global (si lo usas en más secciones) -->
    <script
      src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"
      defer
    ></script>

    <title data-i18n="title"></title>

    <!-- Suavizado de scroll + margen por header fijo para los anclajes -->
    <style>
      html { scroll-behavior: smooth; }
      #hero, #sec-villas, #detalles-financieros, #section-lombok-map { scroll-margin-top: 90px; }
    </style>
  </head>

  <body>
    <!-- ⬇️ Partial del header -->
    <div id="siteHeader"></div>

    <!--==========  HERO (Bootstrap puro)  ==========-->
    <section id="hero" class="section_1 position-relative">
      <div
        id="heroCarousel"
        class="carousel slide carousel-fade"
        data-bs-ride="false"
        data-bs-touch="true"
      >
        <div class="carousel-inner">
          <div class="carousel-item active">
            <img
              src="/images/rul-1.jpg"
              class="d-block w-100 hero-img"
              alt=""
              loading="eager"
            />
          </div>
          <div class="carousel-item">
            <img
              src="/images/rul-3.jpg"
              class="d-block w-100 hero-img"
              alt=""
              loading="lazy"
            />
          </div>
          <div class="carousel-item">
            <img
              src="/images/rul-4.jpg"
              class="d-block w-100 hero-img"
              alt=""
              loading="lazy"
            />
          </div>
        </div>

        <!-- Flechas Bootstrap -->
        <button
          class="carousel-control-prev"
          type="button"
          data-bs-target="#heroCarousel"
          data-bs-slide="prev"
          aria-label="Anterior"
        >
          <span
            class="carousel-control-prev-icon"
            aria-hidden="true"
          ></span>
          <span class="visually-hidden">Anterior</span>
        </button>
        <button
          class="carousel-control-next"
          type="button"
          data-bs-target="#heroCarousel"
          data-bs-slide="next"
          aria-label="Siguiente"
        >
          <span
            class="carousel-control-next-icon"
            aria-hidden="true"
          ></span>
          <span class="visually-hidden">Siguiente</span>
        </button>

        <!-- Overlay -->
        <div class="hero-overlay"></div>

        <!-- Indicadores (thumbnails) -->
        <div class="carousel-indicators thumbnails">
          <button
            type="button"
            data-bs-target="#heroCarousel"
            data-bs-slide-to="0"
            class="active"
            aria-current="true"
            aria-label="Slide 1"
            style="background-image:url('/images/rul-1.jpg');"
          ></button>
          <button
            type="button"
            data-bs-target="#heroCarousel"
            data-bs-slide-to="1"
            aria-label="Slide 2"
            style="background-image:url('/images/rul-3.jpg');"
          ></button>
          <button
            type="button"
            data-bs-target="#heroCarousel"
            data-bs-slide-to="2"
            aria-label="Slide 3"
            style="background-image:url('/images/rul-4.jpg');"
          ></button>
        </div>
      </div>

      <!-- Texto fijo sobre el carrusel -->
      <div class="bg_div">
        <!-- Texto accesible (oculto) con i18n -->
        <h2 class="bg_text1 sr-only">
          <span id="heroWelcomeText" data-i18n="hero.welcome"></span>
        </h2>

        <!-- SVG visible (se rellena por JS con Junge) -->
        <svg id="heroWelcomeSvg" class="hero-welcome-svg" aria-hidden="true"></svg>

        <!-- Mantén tu tagline y CTA tal cual -->
        <h2 class="bg_text2" data-i18n="hero.tagline"></h2>
        <div class="hero-cta">
          <a
            href="#"
            class="btn-cta-ghost"
            data-i18n="hero.cta"
            data-open="#modal-wapp"
            role="button"
            aria-haspopup="dialog"
            aria-controls="modal-wapp"
          >
            Comunidad de WhatsApp
            <span class="btn-cta-arrow" aria-hidden="true">→</span>
          </a>
        </div>
      </div>

      <!-- Stats del hero (NO bloquea clics) -->
      <div class="promo-info reveal" id="promoStats"></div>
    </section>
    <!--==========  /HERO  ==========-->

    <!-- ========= GALERÍA INFINITY (nuevo parcial, reemplaza Día/Noche) ========= -->
    <div id="sec-villas" aria-hidden="true"></div> <!-- Ancla para nav "VILLAS" -->
    <div id="galeriaInfinityHost" data-partial="/partials/galeria-infinity.html"></div>

    <!-- ========== INFINITY (partial) ========== -->
    <div id="infinityHost"></div>

    <!-- ========== DASHBOARD FINANCIERO (partial) ========== -->
    <section id="detalles-financieros">
      <div>
        <div id="siteCharts"></div>
      </div>
    </section>

    <!-- ========== MAPA LOMBOK (partial host) ========== -->
    <div id="lombokMapHost" class="map-scope"></div>

    <!-- CTA flotante → abre modal de Contacto -->
    <a
      href="#"
      id="cta-fixed-btn"
      class="btn btn-brand"
      data-i18n="btn.contact"
      data-open="#modal-contacto"
      role="button"
      aria-haspopup="dialog"
      aria-controls="modal-contacto"
    >
    </a>

    <!-- Contenedor para cargar los modales -->
    <div id="modalHost"></div>

    <!-- ⬇️ Partial del footer -->
    <div id="siteFooter"></div>

    <!--==========  SCRIPTS  ==========-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- i18n init + tu app -->
    <script src="/js/i18n.js"></script>
    <script src="/app.js"></script>

    <!-- Parser TTF/OTF para convertir texto a paths SVG -->
    <script src="https://cdn.jsdelivr.net/npm/opentype.js@1.3.4/dist/opentype.min.js"></script>

    <!-- Carga dinámica de partials (robusta) -->
    <script>
      function absolutizeUrl(url, baseHref){
        try { return new URL(url, baseHref).href; } catch { return url; }
      }

      // 🔧 Limpia inyecciones de Live Server (que rompían el <svg> y los módulos inline)
      function stripLiveServer(html) {
        const tpl = document.createElement('template');
        tpl.innerHTML = html;

        // Elimina comentarios "Code injected by live-server"
        const walker = document.createTreeWalker(tpl.content, NodeFilter.SHOW_COMMENT);
        const toRemove = [];
        let n;
        while ((n = walker.nextNode())) {
          if (/Code injected by live-server/i.test(n.nodeValue || '')) toRemove.push(n);
        }
        toRemove.forEach(c => c.parentNode && c.parentNode.removeChild(c));

        // Elimina scripts con refreshcss / Live-Reloading / /ws
        tpl.content.querySelectorAll('script').forEach(s => {
          const txt = (s.textContent || '') + ' ' + (s.src || '');
          if (/refreshcss|Live-Reloading|\/ws\b/i.test(txt)) s.remove();
        });

        // Devuelve HTML saneado
        const div = document.createElement('div');
        div.appendChild(tpl.content.cloneNode(true));
        return div.innerHTML;
      }

      async function loadPartial(hostOrId, url, opts = {}) {
        const host = typeof hostOrId === 'string' ? document.getElementById(hostOrId) : hostOrId;
        if (!host) throw new Error(`Contenedor no encontrado: ${hostOrId}`);

        const finalUrl = url || host.dataset.partial;
        if (!finalUrl) throw new Error(`Falta URL para el parcial en ${host.id || '(sin-id)'}`);

        const res = await fetch(finalUrl, { cache: 'no-store' });
        if (!res.ok) {
          host.innerHTML = errorBox(finalUrl, `HTTP ${res.status} ${res.statusText}`);
          throw new Error(`HTTP ${res.status} ${res.statusText}`);
        }

        let html = (await res.text()).trim();
        if (!html) { host.remove(); return; }

        // 🧼 saneamos Live Server
        html = stripLiveServer(html);

        // Parse en template
        const tpl = document.createElement('template');
        tpl.innerHTML = html;

        // Normaliza recursos relativos (src/href) al directorio del parcial
        const baseHref = new URL(finalUrl, document.baseURI).href;
        const frag = tpl.content;

        frag.querySelectorAll('img[src], link[href], a[href], script[src]').forEach(el=>{
          const attr = el.tagName === 'LINK' || el.tagName === 'A' ? 'href' : 'src';
          el.setAttribute(attr, absolutizeUrl(el.getAttribute(attr), baseHref));
        });
        frag.querySelectorAll('use[*|href]').forEach(el=>{
          const XLINK = 'http://www.w3.org/1999/xlink';
          const href = el.getAttributeNS(XLINK,'href');
          if(href) el.setAttributeNS(XLINK,'href', absolutizeUrl(href, baseHref));
        });

        const exec = !!opts.executeScripts;
        const scripts = Array.from(frag.querySelectorAll('script'));
        scripts.forEach(s => s.remove());

        // Inserta HTML primero
        host.replaceChildren(frag.cloneNode(true));

        // Ejecuta scripts si procede (charts, etc.)
        if (exec && scripts.length){
          const base = baseHref;
          for (const old of scripts) {
            const s = document.createElement('script');
            if (old.type) s.type = old.type;
            if (old.noModule) s.noModule = true;
            if (old.async) s.async = true;

            if (old.src) {
              s.src = absolutizeUrl(old.getAttribute('src'), base);
            } else {
              const code = old.textContent || '';
              if ((old.type || '').toLowerCase() === 'module') {
                const blob = new Blob([code + `\n//# sourceURL=${finalUrl}.inline.js`], { type: 'text/javascript' });
                s.type = 'module';
                s.src = URL.createObjectURL(blob);
              } else {
                s.textContent = code;
              }
            }
            host.appendChild(s);
          }
        }
      }

      function errorBox(url, msg){
        return `<div style="padding:1rem; background:#fee; border:1px solid #f99">
          No se pudo cargar <code>${url}</code>: ${msg}
        </div>`;
      }

      (async () => {
        // Header/Footer/Charts/Infinity/Galería/Modales en paralelo
        await Promise.all([
          loadPartial("siteHeader", "/partials/header.html",  { executeScripts: false }),
          loadPartial("siteFooter", "/partials/footer.html",  { executeScripts: false }),
          loadPartial("infinityHost","/partials/infinity.html", { executeScripts: false }),
          loadPartial("siteCharts", "/partials/graficos.html",{ executeScripts: true  }),
          loadPartial("galeriaInfinityHost","/partials/galeria-infinity.html",{ executeScripts: false }),
          loadPartial("modalHost", "/partials/modales.html", { executeScripts: true })
        ]);

        // 👇 fuerza traducción de lo que acaba de inyectarse (header, etc.)
        if (window.renderPage) window.renderPage();

        // Cargar parcial del mapa (sin scripts)
        await loadPartial("lombokMapHost", "/partials/map.html", { executeScripts: false });

        // Importar módulos e inicializar
        const [{ initLombokMap }, { initGaleriaInfinity }] = await Promise.all([
          import('/js/mapa.js'),
          import('/js/galeria-infinity.js')
        ]);

        initLombokMap(document.getElementById('lombokMapHost'));
        initGaleriaInfinity(document);

        initHeaderScroll();
      })();

      // Sticky / transparente según hero
      function initHeaderScroll(){
        const header = document.querySelector('header.fixed-top');
        const hero = document.querySelector('#hero') || document.querySelector('.section_1');
        if(!header || !hero) return;

        const io = new IntersectionObserver(
          ([entry]) => header.classList.toggle('scrolled', !entry.isIntersecting),
          { threshold: 0, rootMargin: '-1px 0px 0px 0px' }
        );
        io.observe(hero);

        window.addEventListener('load', ()=>{
          const b = hero.getBoundingClientRect().bottom;
          if (b <= 1) header.classList.add('scrolled');
        });
      }
    </script>

    <!-- Estado "is-stuck" en navbar al salir del hero -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const nav = document.querySelector('.navbar');
        const heroSection = document.querySelector('#hero');
        if (!nav || !heroSection) return;

        const observer = new IntersectionObserver(
          ([entry]) => {
            if (entry.isIntersecting) {
              nav.classList.remove('is-stuck');
            } else {
              nav.classList.add('is-stuck');
            }
          },
          { root: null, threshold: 0, rootMargin: "-80px 0px 0px 0px" }
        );

        observer.observe(heroSection);
      });
    </script>

    <!-- Construcción del SVG + animación de trazo con Anime v4 (después de que exista el SVG) -->
    <script type="module">
      import { animate, svg, stagger } from 'https://cdn.jsdelivr.net/npm/animejs@4.1.3/+esm';

      // Ruta local a tu TTF (asegúrate de que existe y devuelve 200 OK)
      const FONT_URL = '/fonts/Junge-Regular.ttf';

      const SVG = document.getElementById('heroWelcomeSvg');
      const TXT = document.getElementById('heroWelcomeText');
      const NS  = 'http://www.w3.org/2000/svg';

      const getWelcomeText = () =>
        (window.i18next?.t?.('hero.welcome')) || (TXT?.textContent?.trim()) || 'Welcome';

      function buildWord(font, text){
        const SIZE = 160;                   // tamaño base para generar curvas
        const unit = SIZE / font.unitsPerEm;
        const g = document.createElementNS(NS, 'g');
        let x = 0;

        for (const glyph of font.stringToGlyphs(text)) {
          const d = glyph.getPath(x, 0, SIZE).toPathData(2);
          const p = document.createElementNS(NS, 'path');
          p.setAttribute('d', d);
          p.setAttribute('class', 'line');
          g.appendChild(p);
          x += glyph.advanceWidth * unit;
        }

        SVG.innerHTML = '';
        SVG.appendChild(g);

        // ViewBox responsive al contenido
        const b = g.getBBox();
        SVG.setAttribute('viewBox', `${b.x} ${b.y} ${b.width} ${b.height}`);

        // Anima el “draw” del trazo
        const drawables = svg.createDrawable('#heroWelcomeSvg .line');
        animate(drawables, {
          draw: ['0 0','0 1','1 1'],
          ease: 'inOutQuad',
          duration: 2200,
          delay: stagger(110),
          loop: true
        });
      }

      function loadFontAndBuild(){
        const text = getWelcomeText();
        opentype.load(FONT_URL, (err, font) => {
          if (err) { console.error('No se pudo cargar Junge-Regular.ttf', err); return; }
          buildWord(font, text);
        });
      }

      // Re-render cuando i18n cambie o al inicializar
      if (window.i18next){
        if (i18next.isInitialized) loadFontAndBuild();
        i18next.on('initialized', loadFontAndBuild);
        i18next.on('loaded', loadFontAndBuild);
        i18next.on('languageChanged', loadFontAndBuild);
      } else {
        requestAnimationFrame(loadFontAndBuild);
      }
    </script>
  </body>
</html>
